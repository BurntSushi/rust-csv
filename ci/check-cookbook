#!/bin/sh

set -e

D="$(cd "$(dirname "$0")" && pwd -P)"
REPO="$D/.."
SCRIPTS="$REPO/scripts"
TMPDIR="$(mktemp -d)"

"$SCRIPTS/copy-cookbook-examples" \
  --cookbook-file "$REPO/src/cookbook.rs" \
  --example-dir "$TMPDIR"
for new in "$TMPDIR"/*.rs; do
  name="$(basename "$new")"
  old="$(realpath "$REPO"/examples/"$name")"
  if ! diff "$old" "$new"; then
    echo "ERROR: examples/$name differs from ${name%%.rs} in src/cookbook.rs" >&2
    echo "HINT: please run scripts/copy-cookbook-examples" >&2
    exit 1
  fi
done
